<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>扫雷</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
            box-sizing: border-box;
            user-select: none;
            justify-content: center;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin: auto;
        }
        .level {
            max-width: 500px;
            margin-top: 10px;
            font-size: 30px;
        }
        .level button {
            width: 26%;
            height: 35px;
            font-size: 16px;
            line-height: 35px;
            border-radius: 10px;
        }
        .gameBox {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
        }
        .gameBox span {
            display: inline-block;
            background: lightblue;
            border: 1px solid rgb(129, 129, 129);
            border-radius: 0%;
            text-align: center;
            font-weight: 900;
            color: transparent;
        }
    </style>
</head>
<body>
    <div class="level">
        <button type="button" onclick="choice('初级')">初级</button>
        <button type="button" onclick="choice('中级')">中级</button>
        <button type="button" onclick="choice('高级')">高级</button>
    </div>
    <div class="gameBox"></div>
    <div class="info">
        剩余雷数:<span class="residue"></span>&emsp;时间:<span class="tick"></span> S
    </div>
    <script>
        var screenwidth=window.innerWidth>=500?480:window.innerWidth-20;
        var gameBox = document.querySelector('.gameBox')
        var row, col, num,map,table;
        var color={
                '0': "transparent",
                '1': "blue",
                '2': "green",
                '3': "red",
                '4': "navy",
                '5': "maroon",
                '6': "teal",
                '7': "black",
                '8': "gray"};
        choice('中级')
        // 1，成一张雷的地图
        function mineSweepingMap(r, c, num) {
            map = new Array(r)
            // 给行数，生成一个 1 维数组
            var blankMap = function (r,c) {
                for (var i = 0; i < r; i++) {
                    map[i] = new Array(c).fill(0)
                }
            }
            // 给出地雷数量让后随机写入地雷
            var writeInMine = function (num) {
                // 随机位置写入
                var randomLocation = function () {
                    var x = Math.floor(Math.random() * r)
                    var y = Math.floor(Math.random() * c)
                    if (map[x][y] !== 9) {
                        map[x][y] = 9
                    } else {
                        randomLocation()
                    }
                }
                for (var i = 0; i < num; i++) {
                    randomLocation()
                }
            }

            // 使用循环给雷的边上所有数 +1 , 已经是雷的除外
            var plus = function (array, x, y) {
                if (x >= 0 && x < r && y >= 0 && y < c) {
                    if (array[x][y] !== 9) {
                        array[x][y] += 1
                    }
                }
            }
            var writeInHint = function () {
                for (var x = 0; x < map.length; x++) {
                    for (var y = 0; y < map[0].length; y++) {
                        if (map[x][y] === 9) {
                            // 上下 6 个
                            for (var i = -1; i < 2; i++) {
                                plus(map, x - 1, y + i)
                                plus(map, x + 1, y + i)
                            }
                            // 左右 2 个
                            plus(map, x, y + 1)
                            plus(map, x, y - 1)
                        }
                    }
                }
            }
            blankMap(r, c)
            writeInMine(num)
            writeInHint()
        }
        function writeHtml() {
            let html=""
            for (let i = 0; i <row; i++) {
                for (let j = 0; j < col; j++) {
                    html+='<span style="width:'+withspan+'px;height:'+withspan+'px;line-height:'+
                    withspan+'px;font-size: '+withspan/2+'px;" onclick="show('+i+','+j+',this)">'+map[i][j]+'</span>' 
                }
            }
            gameBox.innerHTML=html;
            table = gameBox.children;
        }
        // 判断是否胜利
       function changeClearMineNum() {
            if (clearMineNum === ((col * row) - num)) {
                var allNum = 0
                var stop = setInterval(function () {
                    var r = Math.floor(Math.random() * 256)
                    var g = Math.floor(Math.random() * 256)
                    table[allNum].style.background = `rgba(${r},${g},210,0.6)`
                    table[allNum].style.color="transparent";allNum++
                    if (allNum === table.length) {
                        clearInterval(stop);clearInterval(stopTime)
                        alert('你成功啦~！！晚上吃肉~~！')
                        initializeGame(row, col, num)
                    }
                }, 10)
            }
        }
        // 3，扫雷过程
        var clearMineNum = 0
        function makeWhite(x, y) {
            if (x < row && y < col && x >= 0 && y >= 0) {
                if (table[x*col+y].style.background !== 'white') {
                    table[x*col+y].style.color=color[table[x*col+y].innerText]
                    table[x*col+y].style.background = 'white'
                    clearMineNum++
                    if (table[x*col+y].innerText === '0') {
                        showNoMine(x, y)
                    }
                }
            }
        }
        function showNoMine(x, y) {
            makeWhite(x - 1, y + 1)
            makeWhite(x - 1, y - 1)
            makeWhite(x - 1, y)
            makeWhite(x + 1, y + 1)
            makeWhite(x + 1, y - 1)
            makeWhite(x + 1, y)
            makeWhite(x, y + 1)
            makeWhite(x, y - 1)
        }
        // 给所有方块绑定点击事件，点击显示数字，或者 boom
        function show(x,y) {
            if (table[x*col+y].innerText !== '9') {
                makeWhite(x,y)
                changeClearMineNum()
            } else{
                Num=0// 这里做了个小动画，失败的时候慢慢的显示雷的位置
                var over = setInterval(function () {
                    if (table[Num].innerText === '9') {
                        table[Num].style.background = 'white'
                        table[Num].style.color= 'black'
                        table[Num].innerText = '💣'
                    }
                    Num++
                    if (Num >= table.length) {
                        clearInterval(over);
                        clearInterval(stopTime);
                        alert('游戏失败');
                        initializeGame(row, col, num)
                    }
                }, 10)
            }
        }
        // 4，清除画面，然后写入新的画面
        var stopTime
        function initializeGame(row, col, num) {
            var residue = document.querySelector('.residue')
            residue.innerText = num
            var time = document.querySelector('.tick')
            time.innerText = `0`
            var i = 1
            clearInterval(stopTime)
            stopTime = setInterval(function () {
                time.innerText = i++
            }, 1000)
            gameBox.innerHTML = ''
            clearMineNum = 0
            mineSweepingMap(row, col, num)
            writeHtml()
        }
        function choice(level){
            if (level === '初级') {
                row=9, col=9, num=10;
            } else if (level === '中级') {
                row=16, col=16, num=40;
            } else if (level === '高级') {
                row=32, col=16, num=99;
            }
            withspan=screenwidth/col;
            initializeGame(row, col, num)
        }
    </script>
</body>
</html>