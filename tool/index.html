<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <title>图片水印打码工具</title>
    <style>
        #container {
            max-width: 500px;
            margin: 30px auto;
        }

        h1 { margin: 0 }
        p, article { margin: 0 0 20px 0 }
        article { font-size: 14px; color: #777 }

        label { color: blue; font-size: 17px }
        p label { color: black; display: inline-block; width: 50px; font-size: 15px }
        p { font-size: 15px; line-height: 30px }

        input#text { width: 100%; box-sizing: border-box; font-size: 16px; margin-bottom: 10px }
        input[type=range] { width: 200px; height: 18px; vertical-align: text-bottom }

        canvas { box-sizing: border-box; width: 100%; border: 1px dashed #AAA; cursor: pointer }
    </style>
</head>
    <div id="container">
        <h1>图片水印打码工具</h1>
        <article>安全地为你的图片加水印，无任何网络请求，特别适合各种敏感证件（身份证，驾照，护照等）。</article>

        <label for="image">第一步：先选择一张本地图片</label>
        <p><input type="file" id="image" autocomplete="off"></p>

        <label for="text">第二步：输入需要打水印的文字</label>
        <p><input type="text" id="text" placeholder="请输入文字" autocomplete="off" maxlength="30">
        
        <label for="color">颜色</label>
        <input type="color" id="color" pattern="#[0-9A-Fa-f]{6}" autocomplete="off" value="#0000FF"><br>
        
        <label for="alpha">透明度</label>
        <input type="range" id="alpha" min="0" max="1" step="0.05" autocomplete="off" value="0.15"><br>
        
        <label for="space">间隔</label>
        <input type="range" id="space" min="1" max="8" step="0.2" autocomplete="off" value="4"><br>
        
        <label for="size">字号</label>
        <input type="range" id="size" min="0.5" max="3" step="0.05" autocomplete="off" value="1">
        </p><label for="text">第三步：点击图片下载</label><p id="graph"></p>
    </div>
    <script>
        (function() {
            var $, canvas, dataURItoBlob, drawText, file, generateFileName, graph, image, input, inputItems, makeStyle, readFile, redraw, textCtx;

            $ = function(sel) {
                return document.querySelector(sel);
            };

            inputItems = ['text', 'color', 'alpha', 'space', 'size'];

            input = {};

            image = $('#image');

            graph = $('#graph');

            file = null;

            canvas = null;

            textCtx = null;

            redraw = null;

            dataURItoBlob = function(dataURI) {
                var arr, binStr, i, k, len, ref;
                binStr = atob((dataURI.split(','))[1]);
                len = binStr.length;
                arr = new Uint8Array(len);
                for (i = k = 0, ref = len - 1; (0 <= ref ? k <= ref : k >= ref); i = 0 <= ref ? ++k : --k) {
                arr[i] = binStr.charCodeAt(i);
                }
                return new Blob([arr], {
                type: 'image/png'
                });
            };

            generateFileName = function() {
                var d, pad;
                pad = function(n) {
                if (n < 10) {
                    return '0' + n;
                } else {
                    return n;
                }
                };
                d = new Date;
                return '' + d.getFullYear() + '-' + (pad(d.getMonth() + 1)) + '-' + (pad(d.getDate())) + ' ' + (pad(d.getHours())) + (pad(d.getMinutes())) + (pad(d.getSeconds())) + '.png';
            };

            readFile = function() {
                var fileReader;
                if (file == null) {
                return;
                }
                fileReader = new FileReader;
                fileReader.onload = function() {
                var img;
                img = new Image;
                img.onload = function() {
                    var ctx;
                    canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    textCtx = null;
                    ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    redraw = function() {
                    ctx.rotate(315 * Math.PI / 180);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    return ctx.rotate(45 * Math.PI / 180);
                    };
                    drawText();
                    graph.innerHTML = '';
                    graph.appendChild(canvas);
                    return canvas.addEventListener('click', function() {
                    var blob, imageData, link;
                    link = document.createElement('a');
                    link.download = generateFileName();
                    imageData = canvas.toDataURL('image/png');
                    blob = dataURItoBlob(imageData);
                    link.href = URL.createObjectURL(blob);
                    graph.appendChild(link);
                    return setTimeout(function() {
                        link.click();
                        return graph.removeChild(link);
                    }, 100);
                    });
                };
                return img.src = fileReader.result;
                };
                return fileReader.readAsDataURL(file);
            };

            makeStyle = function() {
                var match;
                match = input.color.value.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
                return 'rgba(' + (parseInt(match[1], 16)) + ',' + (parseInt(match[2], 16)) + ',' + (parseInt(match[3], 16)) + ',' + input.alpha.value + ')';
            };

            drawText = function() {
                var i, j, k, l, margin, ref, ref1, ref2, step, textSize, width, x, y;
                if (canvas == null) {
                return;
                }
                textSize = input.size.value * Math.max(15, (Math.min(canvas.width, canvas.height)) / 25);
                if (textCtx != null) {
                redraw();
                } else {
                textCtx = canvas.getContext('2d');
                textCtx.rotate(45 * Math.PI / 180);
                }
                textCtx.fillStyle = makeStyle();
                textCtx.font = 'bold ' + textSize + 'px -apple-system,"Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","WenQuanYi Micro Hei",sans-serif';
                width = (textCtx.measureText(input.text.value)).width;
                step = Math.sqrt((Math.pow(canvas.width, 2)) + (Math.pow(canvas.height, 2)));
                margin = (textCtx.measureText('啊')).width;
                x = Math.ceil(step / (width + margin));
                y = Math.ceil((step / (input.space.value * textSize)) / 2);
                for (i = k = 0, ref = x; (0 <= ref ? k <= ref : k >= ref); i = 0 <= ref ? ++k : --k) {
                for (j = l = ref1 = -y, ref2 = y; (ref1 <= ref2 ? l <= ref2 : l >= ref2); j = ref1 <= ref2 ? ++l : --l) {
                    textCtx.fillText(input.text.value, (width + margin) * i, input.space.value * textSize * j);
                }
                }
            };

            image.addEventListener('change', function() {
                var ref;
                file = this.files[0];
                if ((ref = file.type) !== 'image/png' && ref !== 'image/jpeg' && ref !== 'image/gif') {
                return alert('仅支持 png, jpg, gif 图片格式');
                }
                return readFile();
            });

            inputItems.forEach(function(item) {
                var el;
                el = $('#' + item);
                input[item] = el;
                return el.addEventListener('input', drawText);
            });

            }).call(this);
    </script>
</html>
