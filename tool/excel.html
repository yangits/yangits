<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>电子表格</title>
<style>
*{
    margin: 0;
    border: 0;
}
th, td{
    border: 1px solid #888;
    position: relative;
    text-align: center;
    font-size: 14px;
    white-space: nowrap;
}
tr:hover{
    background-color: #cff;
}
.selected {
    background-color: #bdf;
}
.copycell{
    box-shadow:inset 0 0 0 1px blue;
}
.hidden{
    display: none;
    pointer-events: none;
}
.col-header,.row-header,.corner{
    min-width:30px;
    z-index: 1;
    position: sticky; 
    left: 0;
    top: 0;
    background-color: #ddd;
}
.col-header{
    min-width: 80px;
}
.cell-input{
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
}
table{
    margin: 1px;
    border: 1px solid #888;
    border-spacing: 0;
    user-select: none;
}
</style>
</head>
<body style="display:flex;height:100vh;flex-direction:column;">
<div class="top"></div>
<div style="overflow:auto;">
    <table id="table">
        <tr id="tableHeader"><th class="corner" style="z-index: 2;"></th></tr>
        <tbody id="tableBody"></tbody>
    </table>
</div>
<script>
const Rows = 100,Cols =26;
var cpdata=null,selCell=null,startCell=[0,0];
var isMouseDown = false;let activeColumn = null;
const tbody = document.getElementById('tableBody');
(function(){
    const headerRow = document.getElementById('tableHeader');
    for (let col = 0; col < Cols; col++) {// 创建列头（字母）
        const th = document.createElement('th');
        th.className = 'col-header';
        th.textContent = String.fromCharCode(65 + col);
        headerRow.appendChild(th);
    }
    for (let row = 0; row < Rows; row++) {// 创建行和数据单元格
        const tr = document.createElement('tr');
        const th = document.createElement('th');
        th.className = 'row-header';
        th.textContent = row + 1;
        tr.appendChild(th);
        for (let col = 0; col < Cols; col++) {
            const td = document.createElement('td');
            td.dataset.row = row;
            td.dataset.col = col;
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
    var data =[["序号","名字"],["1","张三"],["2","李四"],["3","王五"]];
    setData(0,0,data); 
})()
function handleSelection() {
    for (let i = selCell[0]; i <= selCell[2]; i++) {
        for (let j = selCell[1]; j <= selCell[3]; j++) {
            tbody.rows[i].cells[j+1].classList.add('selected');
    }}
}
function removeSelection() {
    var sel_els = document.querySelectorAll('.selected');
    sel_els.forEach((el)=>{
        el.classList.remove('selected');});
    selCell=null;
}
// 初始化事件监听
(function () {
    const table = document.getElementById('table');
    Array.from(table.rows[0].cells).forEach(th => {
        th.onmousedown = function(e) {
            // 当鼠标在列右侧边缘时触发
            if (this.offsetWidth - e.offsetX < 10) {
                activeColumn = this;
                activeColumn.initWidth = this.offsetWidth;
                activeColumn.initX = e.clientX;
            }
        };
        th.onmousemove = function(e) {
            // 改变光标样式
            this.style.cursor = (this.offsetWidth - e.offsetX < 10) 
                ? 'col-resize' : 'default';
        };
    });
    table.addEventListener('mousedown', (e) => {// 鼠标按下事件
        const td = e.target.closest('td');
        if (!td) return;isMouseDown = true;
        removeSelection();
        startCell = [parseInt(td.dataset.row),parseInt(td.dataset.col)];
        selCell=[startCell[0],startCell[1],startCell[0],startCell[1]];
        handleSelection();
    });
    // 鼠标移动事件
    table.addEventListener('mousemove', (e) => {
        if (!isMouseDown) return;
        const td = e.target.closest('td');
        if (!td) return;removeSelection();
        selCell=[Math.min(startCell[0], parseInt(td.dataset.row)),
                Math.min(startCell[1], parseInt(td.dataset.col)),
                Math.max(startCell[0], parseInt(td.dataset.row)),
                Math.max(startCell[1], parseInt(td.dataset.col))]
        handleSelection();
    });
    // 鼠标释放事件
    document.addEventListener('mouseup', () => {
        isMouseDown = false;
    });
    // 双击输入事件
    table.addEventListener('dblclick', (e) => {
        const td = e.target.closest('td');
        if (!td) return;
        const input = document.createElement('input');
        input.className = 'cell-input';
        let text=td.textContent;
        input.value = td.textContent;
        input.addEventListener('blur', () => {
            td.textContent = input.value;
            input.remove();
        });
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                td.textContent = input.value;
                input.remove();
            }
            if (e.key === 'Escape') {
                td.textContent=text;
                input.remove();
            }
        });
        td.appendChild(input);
        input.focus();
    });
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey  && (e.key === 'c'||e.key === 'C')) {
            if (!selCell) return;// 复制功能 Ctrl+C
            var co_els = document.querySelectorAll('.copycell');
            co_els.forEach((el)=>{
                el.classList.remove('copycell');});
            for (let i = selCell[0]; i <= selCell[2]; i++) {
                for (let j = selCell[1]; j <= selCell[3]; j++) {
                tbody.rows[i].cells[j+1].classList.add('copycell');
                }
            }
            cpdata=getData(selCell);
            navigator.clipboard.writeText(cpdata);
        }
        if (e.ctrlKey && (e.key === 'v'||e.key === 'V')) {
            if (!cpdata || !selCell)return;// 粘贴功能 Ctrl+V
            for(i=selCell[0];i<=selCell[2];i+=cpdata.length){
                for(j=selCell[1];j<=selCell[3];j+=cpdata[0].length){
                    setData(i,j,cpdata);
            }}
        }
        if (e.ctrlKey && (e.key === 'm' || e.key === 'M')) {
            e.preventDefault();
            mergeCells(selCell);
        }
        if (e.key === 'Escape') {
            cpdata=null;removeSelection();
            var co_els = document.querySelectorAll('.copycell');
            co_els.forEach((el)=>{
                el.classList.remove('copycell');});
        }
        if (e.key === 'Delete') {
            for (let i = selCell[0]; i <= selCell[2]; i++) {
                for (let j = selCell[1]; j <= selCell[3]; j++) {
                    tbody.rows[i].cells[j+1].textContent="";
                }
            };
        }
    });
})()
function getData(selCell) {
    let data=[]
    for (let i = selCell[0]; i <= selCell[2]; i++) {
        data.push([])
        for (let j = selCell[1]; j <= selCell[3]; j++) {
            data[i-selCell[0]].push(tbody.rows[i].cells[j+1].textContent)
        }
    }
    return data
}
function setData(row,col,data) {
    for (let i = 0; i < data.length; i++) {
        for (let j = 0; j < data[i].length; j++) {
        // cells[0]是行头，数据从cells[1]开始
        tbody.rows[i+row].cells[j+col+1].textContent = data[i][j];
        }
    }
}
function mergeCells(selCell) {// 修改后的合并单元格函数
    if (!selCell) return;
    let [sr, sc, er, ec] = selCell;
    const startTd = tbody.rows[sr].cells[sc+1];
    startTd.rowSpan = er - sr + 1;
    startTd.colSpan = ec - sc + 1;
    if(sr === er && sc === ec){
        endcell=tbody.rows[sr].cells[sc+1].dataset.merged;
        if(!endcell)return
        [er, ec]=endcell.split(",").map(Number);
        for (let i = sr; i <= er; i++) {
        for (let j = sc; j <= ec; j++) {
            if (i === sr && j === sc) {continue}
            const td = tbody.rows[i].cells[j+1];
            td.classList.remove('hidden');
        }
    }
    }else{
        tbody.rows[sr].cells[sc+1].dataset.merged=[er, ec]
        for (let i = sr; i <= er; i++) {
        for (let j = sc; j <= ec; j++) {
            if (i === sr && j === sc) {continue}
            const td = tbody.rows[i].cells[j+1];
            td.classList.add('hidden');
        }}
    }
}
</script>
</body>
</html>